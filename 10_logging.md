10_logging

Добавим в проект логирование – будем заниматься протоколированием действий, которые выполняются на сервере.

Первый вопрос – почему просто нельзя использовать console.log и перенаправлять поток вывода в файл? console.log блокирует выполнение, это негативно сказывается на работе node.

Воспользуемся вместо этого какой-нибудь библиотекой для логирования, например bunyan. Устанавливаем библиотеку

`npm install bunyan --save`

Создадим на сервере отдельную папку для сбора логов - `/log`

Создение простого логера на bunyan занимает минимум времени – создадим переменную log, которая будет писать лог.

```js
…
const logger  = require('bunyan'),
…
const log = new logger({ name: 'index' });
```

Теперь можно вместо console.log выводить данные в лог

`log.info(`Server listening to ${Settings.server.schema}://${Settings.server.host}:${Settings.server.port}`);`

В нашем случае лог имеет имя index. Каждый логер в bunyan должен иметь своё уникальное имя.

По умолчанию, логер выводит данные в стандартный поток вывода stdout. Настроим его так, чтобы он писал в файл.

```js
const log = new logger({ 
	name: 'index',
	streams: [{
		path: 'log/stdout.log',
		level: 'info'
	}]
});
```

Для записи мы использовали `streams` – набор потоков, который в зависимости от уровня логирования могут писать данные в разные файлы. Уровень определяет критичность сообщения. Например, `info` (ему соответствует вызов `log.info`) это информационные сообщения, `error` – Ошибки и т.д.

Создадим два потока – для ошибок и для вывода информации. Чтобы не захламлять код, перенесём настройки в Settings

```js
logging: {
	'index': { 
		name: 'index',
		streams: [{
			path: path.resolve(__dirname + '../../../log/info.log'),
			level: 'info'
		}, {
			path: path.resolve(__dirname + '../../../log/error.log'),
			level: 'error'
		}]
	}
}
```

Теперь обработаем ошибку запуска сервера. Если создать два экземпляра сервера, то один из них выбросит ошибку, так как порт уже будет занят. Повесим обработчик ошибок нашего приложения и добавим логгирование в файл ошибок.

```js
(async () => {
	await router(app);
	await app.listen(Settings.server.port).on('error', (err) => {
		log.error(err);
	});
	log.info(`Server listening to ${Settings.server.schema}://${Settings.server.host}:${Settings.server.port}`);
})();
```

Теперь, если запустить две сервера одновременно, то второй прекратит работу и выведет ошибку в файл `error.log`
